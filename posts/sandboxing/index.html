<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-GHZ0SBNQLB"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GHZ0SBNQLB")</script><title>Sandboxing using Docker - cheatsheet &ndash; piotrek-k.pl</title><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous><link rel=stylesheet href=https://piotrek-k.pl/css/colour/gruvbox-dark.css><link rel=stylesheet href=https://piotrek-k.pl/css/colour/dark-mode.css><link rel=stylesheet href=https://piotrek-k.pl/css/risotto.css><link rel=stylesheet href=https://piotrek-k.pl/css/custom.css></head><body><div class=page><header class=page__header><h1 class=page__logo><a href=https://piotrek-k.pl class=page__logo-inner>piotrek-k.pl</a></h1><nav class="page__nav main-nav"><ul><li class=main-nav__item><a class=nav-main-item href=/about/ title>About</a></li><li class=main-nav__item><a class=nav-main-item href=/projects/ title>Projects</a></li><li class=main-nav__item><a class="nav-main-item active" href=/posts/ title=Posts>Posts</a></li></ul></nav></header><section class=page__body><ul class=breadcrumb><li><a href=/>Home</a></li><li><a href=/posts/>Posts</a></li><li class=active><a href=/posts/sandboxing/>Sandboxing using Docker - cheatsheet</a></li></ul><div class=tags-list></div><header class=content__header><h1>Sandboxing using Docker - cheatsheet</h1></header><div class=content__body><p>The following cheatsheet is meant to show how to use Docker to sandbox untrusted code. The goal is to minimize the damage that could be made by malicius code downloaded from untrusted source.</p><p>Running a code this way allows to:</p><ul><li>prevent code from accessing the rest of the filesystem</li><li>easily revert all changes</li><li>run a code with near native performance</li><li>control network access</li><li>run processes as superuser without giving them controll of entire device</li></ul><p><a href=https://docs.docker.com/engine/security/>More on Docker security</a></p><p>The main downside of using Docker is that it shares the same kernel as the host, which means that vulnerabilities of host&rsquo;s kernel could be used to escape from container. There are other ways to sandbox code like virtualization, AppArmor, firejail.</p><h2 id=run-a-command-in-a-disposible-container>Run a command in a disposible container</h2><pre tabindex=0><code>docker run [OPTIONS] IMAGE [COMMAND] [ARG...]
</code></pre><p>Example for python:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it --rm --name my-running-script -v <span style=color:#e6db74>&#34;</span>$PWD<span style=color:#e6db74>&#34;</span>:/usr/src/myapp -w /usr/src/myapp python:3 python script.py
</span></span></code></pre></div><p>It crates python3 container, runs a <code>python script.py</code> command and removes it as soon as script finishes execution.</p><p>Arguments breakdown:</p><ul><li><code>-it</code> runs a command with interactive shell. Allows you to provide input</li><li><code>--rm</code> removes container as soon as it finishes executing</li><li><code>-v "$PWD":/usr/src/myapp</code> points your current directory (on host machine) to path <code>/usr/src/myapp</code> inside a container</li><li><code>-w</code> sets working directory to <code>/usr/src/myapp</code></li><li><code>python:3</code> is a base docker image, on which we are running our command</li><li><code>python script.py</code> is a command we want to run inside a container</li></ul><p>Effect (only seen when container is still running):</p><pre tabindex=0><code>$ docker ps -a
CONTAINER ID   IMAGE                                              COMMAND                  CREATED         STATUS                       PORTS     NAMES
3dc148f99f74   python:3                                           &#34;python script.py&#34;       5 seconds ago   Up 4 seconds                           my-running-script
</code></pre><p>For multiple commands (runs <code>sh</code> command which then executes chain of commands)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it --rm --name my-running-script -v <span style=color:#e6db74>&#34;</span>$PWD<span style=color:#e6db74>&#34;</span>:/usr/src/myapp -w /usr/src/myapp python:3 sh -c <span style=color:#e6db74>&#34;python script.py &amp;&amp; echo test&#34;</span>
</span></span></code></pre></div><h2 id=accessing-running-containers-filesystem>Accessing running container&rsquo;s filesystem</h2><p>If container is still running (<code>docker ps -a</code> returns status &ldquo;Up&rdquo;):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker exec -it b325ffe9fe18 /bin/bash
</span></span></code></pre></div><p>Where <code>b325ffe9fe18</code> is a container id.</p><h2 id=accessing-closed-containers-filesystem>Accessing closed container&rsquo;s filesystem</h2><p>If status of container is &ldquo;Exited&rdquo; we cannot enter shell in it. But if we still want to inspect files, processes and make use of stuff in it, we can make snapshot of it and run it independently.</p><p>Assuming we create non-disposable container like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it --name my-running-script -v <span style=color:#e6db74>&#34;</span>$PWD<span style=color:#e6db74>&#34;</span>:/usr/src/myapp -w /usr/src/myapp python:3 python script.py
</span></span></code></pre></div><p>And <code>docker ps -a</code> command returns:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker ps -a
</span></span><span style=display:flex><span>CONTAINER ID   IMAGE                                              COMMAND                  CREATED         STATUS                       PORTS     NAMES
</span></span><span style=display:flex><span>69b5fe1b8934   python:3                                           <span style=color:#e6db74>&#34;python script.py&#34;</span>       <span style=color:#ae81ff>5</span> seconds ago   Exited <span style=color:#f92672>(</span>0<span style=color:#f92672>)</span> <span style=color:#ae81ff>4</span> seconds ago               my-running-script
</span></span></code></pre></div><p>Commit the stopped container:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker commit 69b5fe1b8934 image_name_of_snapshot
</span></span></code></pre></div><p>Where <code>image_name_of_snapshot</code> is a name for newly created image.</p><p>Result:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker images
</span></span><span style=display:flex><span>REPOSITORY                                  TAG                  IMAGE ID       CREATED          SIZE
</span></span><span style=display:flex><span>image_name_of_snapshot                      latest               692b940a0f2a   <span style=color:#ae81ff>45</span> seconds ago   920MB
</span></span></code></pre></div><p>Then to enter shell:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it --rm --entrypoint /bin/bash image_name_of_snapshot
</span></span></code></pre></div><h2 id=more-complex-scenarios>More complex scenarios</h2><p>Create Dockerfile:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> python:3</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /usr/src/app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> script.py .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [ <span style=color:#e6db74>&#34;python&#34;</span>, <span style=color:#e6db74>&#34;./script.py&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Then build:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t test_base_image . --load
</span></span></code></pre></div><p>Then run and log in to shell:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it --entrypoint /bin/bash test_base_image
</span></span></code></pre></div></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><b class=about__title>Links</b></div><ul class=aside__social-links><li><a href=https://github.com/piotrek-k rel=me aria-label=GitHub title=GitHub><i class="fab fa-github" aria-hidden=true></i></a>&nbsp;</li><li><a href=mailto:inbox+website@kozer.ski rel=me aria-label=Email title=Email><i class="fas fa-envelope" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://www.linkedin.com/in/piotr-kozerski/ rel=me aria-label=LinkedIn title=LinkedIn><i class="fab fa-linkedin" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://stackoverflow.com/users/1804027/piotrek rel=me aria-label=StackOverflow title=StackOverflow><i class="fab fa-stack-overflow" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2023-06-11</p></div></section><footer class=page__footer><style>#consent-notice{padding:1rem;display:none;text-align:center;position:fixed;bottom:0;left:0;width:100%;background:#222;color:rgba(255,255,255,.8)}#consent-notice span{margin-right:1rem}#consent-notice button{cursor:pointer;display:inline-block;width:auto}#consent-notice span a{color:inherit;text-decoration:underline;text-decoration-color:rgba(255,255,255,.5)}#consent-notice button.btn{margin-left:.5rem}#consent-notice button.btn.manage-consent{background:rgba(255,255,255,.1);font-weight:400}#consent-overlay{position:fixed;left:0;top:0;width:100%;height:100vh;display:none;background:rgba(0,0,0,.75);z-index:999999;overflow:auto;cursor:pointer}#consent-overlay.active{display:flex}#consent-overlay>div{background:#fff;width:100%;max-width:30rem;padding:1.75rem;margin:auto;cursor:initial}#consent-overlay>div>div{display:flex;align-items:flex-start;margin-bottom:1rem}#consent-overlay>div>div:last-child{margin:0}#consent-overlay h3{padding-top:0}#consent-overlay input{margin-top:.3rem}#consent-overlay label{display:block}#consent-overlay .btn{margin-right:.5rem}#consent-overlay button.btn.save-consent{background:rgba(0,0,0,.6);font-weight:400}@media(max-width:767px){#consent-overlay>div{padding:1.75rem 1rem}#consent-notice span{display:block;padding-top:3px;margin-bottom:1.5rem}#consent-notice button.btn{position:relative;bottom:4px}}.btn,input[type=submit],button{background:#f72c72;font-weight:700;color:rgba(255,255,255,.8);text-decoration:none;padding:.35rem .7rem;border:0;cursor:pointer;border-radius:.25rem}#consent-overlay h3{color:#444;cursor:default;padding-bottom:.5rem;margin:0}#consent-overlay h3:before{content:''}#consent-overlay .consent-optionstext{padding-left:1rem}</style><div id=consent-notice><span>We would like to use <a class=manage-consent href=#manage-consent>third party code</a> to improve the functionality of this website.</span><button class="btn manage-consent">Manage preferences</button><button class="btn deny-consent">Deny</button><button class="btn approve-consent">Allow</button></div><div id=consent-overlay><div><div><input type=checkbox id=item0 value=1 name=item0 checked disabled>
<label for=item0 class=consent-optionstext><h3>Google Anaytics (functional)</h3><p>Used for measuring page views. As it is functional requirement, it cannot be disabled.</p></label></div><div><button id=save-consent class="btn save-consent" data-consentvalue>Save preferences</button>
<button class="btn approve-consent">Allow all</button></div></div></div><script>const scripts=[];scripts[0]="/js/ga.js";function createCookie(e,t,n){var s,o="";n&&(s=new Date,s.setTime(s.getTime()+n*24*60*60*1e3),o="; expires="+s.toUTCString()),document.cookie=e+"="+t+o+"; path=/"}function readCookie(e){for(var t,s=e+"=",o=document.cookie.split(";"),n=0;n<o.length;n++){for(t=o[n];t.charAt(0)==" ";)t=t.substring(1,t.length);if(t.indexOf(s)==0)return t.substring(s.length,t.length)}return null}function eraseCookie(e){createCookie(e,"",-1)}function denyAllConsentScripts(){var e="";scripts.forEach(function(){e=e+"0"}),acceptSomeConsentScripts(e)}function acceptAllConsentScripts(){var e="";scripts.forEach(function(){e=e+"1"}),acceptSomeConsentScripts(e)}function acceptSomeConsentScripts(e){setConsentInputs(e),createCookie("consent-settings",e,31),document.getElementById("consent-notice").style.display="none",document.getElementById("consent-overlay").classList.remove("active"),loadConsentScripts(e)}function loadConsentScripts(e){scripts.forEach(function(t,n){if(e[n]=="1"){var s=document.createElement("script");s.type="text/javascript",s.src=t,document.body.appendChild(s)}})}function setConsentInputs(e){var t=document.querySelectorAll("#consent-overlay input:not([disabled])");t.forEach(function(t,n){e[n]=="1"?t.checked=!0:t.checked=!1})}function setConsentValue(){var t=document.querySelectorAll("#consent-overlay input:not([disabled])"),e="";t.forEach(function(t){t.checked?e=e+"1":e=e+"0"}),document.getElementById("save-consent").dataset.consentvalue=e}var elements=document.querySelectorAll("#consent-overlay input:not([disabled])"),consentValue;elements.forEach(function(e){e.checked=!1}),readCookie("consent-settings")?(consentValue=readCookie("consent-settings").toString(),setConsentInputs(consentValue),loadConsentScripts(consentValue)):document.getElementById("consent-notice").style.display="block",elements=document.querySelectorAll(".manage-consent"),elements.forEach(function(e){e.addEventListener("click",function(){document.getElementById("consent-overlay").classList.toggle("active")})}),elements=document.querySelectorAll(".deny-consent"),elements.forEach(function(e){e.addEventListener("click",function(){denyAllConsentScripts()})}),elements=document.querySelectorAll(".approve-consent"),elements.forEach(function(e){e.addEventListener("click",function(){acceptAllConsentScripts()})}),document.getElementById("save-consent").addEventListener("click",function(){setConsentValue(),acceptSomeConsentScripts(this.dataset.consentvalue)}),document.getElementById("consent-overlay").addEventListener("click",function(e){document.querySelector("#consent-overlay > div").contains(e.target)||this.classList.toggle("active")})</script><script type=text/javascript src=/js/ga.js></script></footer></div></body></html>