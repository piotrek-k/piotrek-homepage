<!doctype html><html lang=en><head><title>Sandboxing using Docker - cheatsheet Â· piotrek-k.pl</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Piotr Kozerski"><meta name=description content="The following cheatsheet is meant to show how to use Docker to sandbox untrusted code. The goal is to minimize the damage that could be made by malicius code downloaded from untrusted source.
Running a code this way allows to:
prevent code from accessing the rest of the filesystem easily revert all changes run a code with near native performance control network access run processes as superuser without giving them controll of entire device More on Docker security"><meta name=keywords content="portfolio,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Sandboxing using Docker - cheatsheet"><meta name=twitter:description content="The following cheatsheet is meant to show how to use Docker to sandbox untrusted code. The goal is to minimize the damage that could be made by malicius code downloaded from untrusted source.
Running a code this way allows to:
prevent code from accessing the rest of the filesystem easily revert all changes run a code with near native performance control network access run processes as superuser without giving them controll of entire device More on Docker security"><meta property="og:title" content="Sandboxing using Docker - cheatsheet"><meta property="og:description" content="The following cheatsheet is meant to show how to use Docker to sandbox untrusted code. The goal is to minimize the damage that could be made by malicius code downloaded from untrusted source.
Running a code this way allows to:
prevent code from accessing the rest of the filesystem easily revert all changes run a code with near native performance control network access run processes as superuser without giving them controll of entire device More on Docker security"><meta property="og:type" content="article"><meta property="og:url" content="https://piotrek-k.pl/posts/sandboxing/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-11T20:06:59+02:00"><meta property="article:modified_time" content="2023-06-11T20:06:59+02:00"><link rel=canonical href=https://piotrek-k.pl/posts/sandboxing/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.5adbe72fc41dcfb852215b84695288939b6b606db73238bd3ee936469572fc9c.css integrity="sha256-WtvnL8Qdz7hSIVuEaVKIk5trYG23Mji9Puk2RpVy/Jw=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/styles.min.ec12b20f80f2eb2e22cd86c84e76b663f0640e8f045c2c4044a3ed35ed8d36b9.css integrity="sha256-7BKyD4Dy6y4izYbITna2Y/BkDo8EXCxARKPtNe2NNrk=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/img/favicon.svg sizes=any><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>piotrek-k.pl</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Posts</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://piotrek-k.pl/posts/sandboxing/>Sandboxing using Docker - cheatsheet</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-06-11T20:06:59+02:00>June 11, 2023</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
3-minute read</span></div></div></header><div class=post-content><p>The following cheatsheet is meant to show how to use Docker to sandbox untrusted code. The goal is to minimize the damage that could be made by malicius code downloaded from untrusted source.</p><p>Running a code this way allows to:</p><ul><li>prevent code from accessing the rest of the filesystem</li><li>easily revert all changes</li><li>run a code with near native performance</li><li>control network access</li><li>run processes as superuser without giving them controll of entire device</li></ul><p><a href=https://docs.docker.com/engine/security/ class=external-link target=_blank rel=noopener>More on Docker security</a></p><p>The main downside of using Docker is that it shares the same kernel as the host, which means that vulnerabilities of host&rsquo;s kernel could be used to escape from container. There are other ways to sandbox code like virtualization, AppArmor, firejail.</p><h2 id=run-a-command-in-a-disposible-container>Run a command in a disposible container
<a class=heading-link href=#run-a-command-in-a-disposible-container><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><pre tabindex=0><code>docker run [OPTIONS] IMAGE [COMMAND] [ARG...]
</code></pre><p>Example for python:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it --rm --name my-running-script -v <span style=color:#a5d6ff>&#34;</span><span style=color:#79c0ff>$PWD</span><span style=color:#a5d6ff>&#34;</span>:/usr/src/myapp -w /usr/src/myapp python:3 python script.py
</span></span></code></pre></div><p>It crates python3 container, runs a <code>python script.py</code> command and removes it as soon as script finishes execution.</p><p>Arguments breakdown:</p><ul><li><code>-it</code> runs a command with interactive shell. Allows you to provide input</li><li><code>--rm</code> removes container as soon as it finishes executing</li><li><code>-v "$PWD":/usr/src/myapp</code> points your current directory (on host machine) to path <code>/usr/src/myapp</code> inside a container</li><li><code>-w</code> sets working directory to <code>/usr/src/myapp</code></li><li><code>python:3</code> is a base docker image, on which we are running our command</li><li><code>python script.py</code> is a command we want to run inside a container</li></ul><p>Effect (only seen when container is still running):</p><pre tabindex=0><code>$ docker ps -a
CONTAINER ID   IMAGE                                              COMMAND                  CREATED         STATUS                       PORTS     NAMES
3dc148f99f74   python:3                                           &#34;python script.py&#34;       5 seconds ago   Up 4 seconds                           my-running-script
</code></pre><p>For multiple commands (runs <code>sh</code> command which then executes chain of commands)</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it --rm --name my-running-script -v <span style=color:#a5d6ff>&#34;</span><span style=color:#79c0ff>$PWD</span><span style=color:#a5d6ff>&#34;</span>:/usr/src/myapp -w /usr/src/myapp python:3 sh -c <span style=color:#a5d6ff>&#34;python script.py &amp;&amp; echo test&#34;</span>
</span></span></code></pre></div><h2 id=accessing-running-containers-filesystem>Accessing running container&rsquo;s filesystem
<a class=heading-link href=#accessing-running-containers-filesystem><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>If container is still running (<code>docker ps -a</code> returns status &ldquo;Up&rdquo;):</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker exec -it b325ffe9fe18 /bin/bash
</span></span></code></pre></div><p>Where <code>b325ffe9fe18</code> is a container id.</p><h2 id=accessing-closed-containers-filesystem>Accessing closed container&rsquo;s filesystem
<a class=heading-link href=#accessing-closed-containers-filesystem><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>If status of container is &ldquo;Exited&rdquo; we cannot enter shell in it. But if we still want to inspect files, processes and make use of stuff in it, we can make snapshot of it and run it independently.</p><p>Assuming we create non-disposable container like this:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it --name my-running-script -v <span style=color:#a5d6ff>&#34;</span><span style=color:#79c0ff>$PWD</span><span style=color:#a5d6ff>&#34;</span>:/usr/src/myapp -w /usr/src/myapp python:3 python script.py
</span></span></code></pre></div><p>And <code>docker ps -a</code> command returns:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker ps -a
</span></span><span style=display:flex><span>CONTAINER ID   IMAGE                                              COMMAND                  CREATED         STATUS                       PORTS     NAMES
</span></span><span style=display:flex><span>69b5fe1b8934   python:3                                           <span style=color:#a5d6ff>&#34;python script.py&#34;</span>       <span style=color:#a5d6ff>5</span> seconds ago   Exited <span style=color:#ff7b72;font-weight:700>(</span>0<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#a5d6ff>4</span> seconds ago               my-running-script
</span></span></code></pre></div><p>Commit the stopped container:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker commit 69b5fe1b8934 image_name_of_snapshot
</span></span></code></pre></div><p>Where <code>image_name_of_snapshot</code> is a name for newly created image.</p><p>Result:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker images
</span></span><span style=display:flex><span>REPOSITORY                                  TAG                  IMAGE ID       CREATED          SIZE
</span></span><span style=display:flex><span>image_name_of_snapshot                      latest               692b940a0f2a   <span style=color:#a5d6ff>45</span> seconds ago   920MB
</span></span></code></pre></div><p>Then to enter shell:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it --rm --entrypoint /bin/bash image_name_of_snapshot
</span></span></code></pre></div><h2 id=more-complex-scenarios>More complex scenarios
<a class=heading-link href=#more-complex-scenarios><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Create Dockerfile:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#ff7b72>FROM</span><span style=color:#a5d6ff> python:3</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>WORKDIR</span><span style=color:#a5d6ff> /usr/src/app</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>COPY</span> script.py .<span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>CMD</span> [ <span style=color:#a5d6ff>&#34;python&#34;</span>, <span style=color:#a5d6ff>&#34;./script.py&#34;</span> ]<span style=color:#f85149>
</span></span></span></code></pre></div><p>Then build:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t test_base_image . --load
</span></span></code></pre></div><p>Then run and log in to shell:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it --entrypoint /bin/bash test_base_image
</span></span></code></pre></div></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme"),themeInParams="auto";getTheme==null&&(themeInParams!==""&&themeInParams!=="auto"?getTheme=themeInParams:getTheme=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","piotrek-k/piotrek-k.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><div id=consent-notice><span>We would like to use <a class=manage-consent href=#manage-consent>third party code</a> to improve the functionality of this website.</span><button class="btn manage-consent">Manage preferences</button><button class="btn deny-consent">Deny</button><button class="btn approve-consent">Allow</button></div><div id=consent-overlay><div><div><input type=checkbox id=item0 value=1 name=item0 checked disabled>
<label for=item0 class=consent-optionstext><h3>Google Anaytics (functional)</h3><p>Used for measuring page views. As it is functional requirement, it cannot be disabled.</p></label></div><div><button id=save-consent class="btn save-consent" data-consentvalue>Save preferences</button>
<button class="btn approve-consent">Allow all</button></div></div></div><script>const scripts=[];scripts[0]="/js/ga.js";function createCookie(e,t,n){var s,o="";n&&(s=new Date,s.setTime(s.getTime()+n*24*60*60*1e3),o="; expires="+s.toUTCString()),document.cookie=e+"="+t+o+"; path=/"}function readCookie(e){for(var t,s=e+"=",o=document.cookie.split(";"),n=0;n<o.length;n++){for(t=o[n];t.charAt(0)==" ";)t=t.substring(1,t.length);if(t.indexOf(s)==0)return t.substring(s.length,t.length)}return null}function eraseCookie(e){createCookie(e,"",-1)}function denyAllConsentScripts(){var e="";scripts.forEach(function(){e=e+"0"}),acceptSomeConsentScripts(e)}function acceptAllConsentScripts(){var e="";scripts.forEach(function(){e=e+"1"}),acceptSomeConsentScripts(e)}function acceptSomeConsentScripts(e){setConsentInputs(e),createCookie("consent-settings",e,31),document.getElementById("consent-notice").style.display="none",document.getElementById("consent-overlay").classList.remove("active"),loadConsentScripts(e)}function loadConsentScripts(e){scripts.forEach(function(t,n){if(e[n]=="1"){var s=document.createElement("script");s.type="text/javascript",s.src=t,document.body.appendChild(s)}})}function setConsentInputs(e){var t=document.querySelectorAll("#consent-overlay input:not([disabled])");t.forEach(function(t,n){e[n]=="1"?t.checked=!0:t.checked=!1})}function setConsentValue(){var t=document.querySelectorAll("#consent-overlay input:not([disabled])"),e="";t.forEach(function(t){t.checked?e=e+"1":e=e+"0"}),document.getElementById("save-consent").dataset.consentvalue=e}var elements=document.querySelectorAll("#consent-overlay input:not([disabled])"),consentValue;elements.forEach(function(e){e.checked=!1}),readCookie("consent-settings")?(consentValue=readCookie("consent-settings").toString(),setConsentInputs(consentValue),loadConsentScripts(consentValue)):document.getElementById("consent-notice").style.display="block",elements=document.querySelectorAll(".manage-consent"),elements.forEach(function(e){e.addEventListener("click",function(){document.getElementById("consent-overlay").classList.toggle("active")})}),elements=document.querySelectorAll(".deny-consent"),elements.forEach(function(e){e.addEventListener("click",function(){denyAllConsentScripts()})}),elements=document.querySelectorAll(".approve-consent"),elements.forEach(function(e){e.addEventListener("click",function(){acceptAllConsentScripts()})}),document.getElementById("save-consent").addEventListener("click",function(){setConsentValue(),acceptSomeConsentScripts(this.dataset.consentvalue)}),document.getElementById("consent-overlay").addEventListener("click",function(e){document.querySelector("#consent-overlay > div").contains(e.target)||this.classList.toggle("active")})</script><script type=text/javascript src=/js/ga.js></script><footer class=footer><section class=container>Â©
2022 -
2023
Piotr Kozerski
Â·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>